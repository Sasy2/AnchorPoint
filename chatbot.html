<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AI Mental Health Coach</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#427cf0",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .chat-message {
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-[#111318] dark:text-gray-200">
<div class="relative flex min-h-screen w-full">
<!-- Side Navigation -->
<aside class="flex h-screen w-64 flex-col border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-background-dark p-4 sticky top-0">
<div class="flex h-full flex-col justify-between">
<div class="flex flex-col gap-4">
<div class="flex items-center gap-3">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="AI Coach Avatar" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBGThubcJTcbKFox870ow6d2mLNSj6ZOwxyP0I0mcdwSfeO3QwepCy-W5ozZbclOUp7YHDaVY8euFAcKCAJwcmMZhd5s2HsmWDUBPou6KI7o0fpz-A9jvzRoZdaxlm9UjzDO6WClAM1qY9M49-qBPPNFyOgV-xUxYdAXdjicGwKqNolvXK9ls_CrJR_ddf8DIxmwKmwVT5hbks7AEFcOBSJ2-mKZpxvkzspHQ8aq67RjEtMVK1q7AAH6ipQU7UgpxHsgSoLScGLnQ1J");'></div>
<div class="flex flex-col">
<h1 class="text-base font-medium leading-normal text-[#111318] dark:text-white">AI Mental Health Coach</h1>
<p class="text-sm font-normal leading-normal text-[#616f89] dark:text-gray-400">Your supportive companion</p>
</div>
</div>
<nav class="mt-4 flex flex-col gap-2">
<a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors" href="index.html">
<span class="material-symbols-outlined text-[#111318] dark:text-gray-300">home</span>
<p class="text-sm font-medium leading-normal text-[#111318] dark:text-gray-300">Home</p>
</a>
<a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors" href="activities.html">
<span class="material-symbols-outlined text-[#111318] dark:text-gray-300">grass</span>
<p class="text-sm font-medium leading-normal text-[#111318] dark:text-gray-300">Activities</p>
</a>
<a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 text-primary dark:bg-primary/30 dark:text-primary" href="chatbot.html">
<span class="material-symbols-outlined !fill-1">psychology</span>
<p class="text-sm font-medium leading-normal">AI Coach</p>
</a>
<a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 transition-colors" href="community.html">
<span class="material-symbols-outlined text-[#111318] dark:text-gray-300">groups</span>
<p class="text-sm font-medium leading-normal text-[#111318] dark:text-gray-300">Community</p>
</a>
</nav>
</div>
<div class="flex flex-col gap-1">
<button id="clear-chat-btn" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/20 transition-colors text-red-600 dark:text-red-400">
<span class="material-symbols-outlined">delete</span>
<p class="text-sm font-medium leading-normal">Clear Chat</p>
</button>
</div>
</div>
</aside>

<!-- Main Chat Area -->
<main class="flex-1 flex flex-col">
<!-- Chat Header -->
<div class="border-b border-gray-200 dark:border-gray-800 p-4">
<div class="flex items-center justify-between">
<div class="flex items-center gap-3">
<div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center">
<span class="material-symbols-outlined text-primary">psychology</span>
</div>
<div>
<h1 class="text-lg font-bold text-[#111318] dark:text-white">AI Mental Health Coach</h1>
<p class="text-sm text-[#616f89] dark:text-gray-400">I'm here to support you on your mental health journey</p>
</div>
</div>
<div class="flex items-center gap-2">
<span id="connection-status" class="flex items-center gap-1 text-sm text-green-600 dark:text-green-400">
<span class="w-2 h-2 bg-green-500 rounded-full"></span>
Online
</span>
</div>
</div>
</div>

<!-- Chat Messages -->
<div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
<!-- Welcome message -->
<div class="chat-message flex items-start gap-3">
<div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
<span class="material-symbols-outlined text-primary text-sm">psychology</span>
</div>
<div class="bg-white dark:bg-gray-800 rounded-lg p-3 max-w-md">
<p class="text-sm text-[#111318] dark:text-white">Hello! I'm your AI Mental Health Coach. I'm here to provide supportive guidance and help you navigate your mental health journey. How are you feeling today?</p>
<p class="text-xs text-[#616f89] dark:text-gray-400 mt-1">Just now</p>
</div>
</div>
</div>

<!-- Chat Input -->
<div class="border-t border-gray-200 dark:border-gray-800 p-4">
<div class="flex items-end gap-3">
<div class="flex-1">
<textarea id="message-input" class="w-full resize-none border border-gray-300 dark:border-gray-600 rounded-lg p-3 bg-white dark:bg-gray-800 text-[#111318] dark:text-white placeholder:text-[#616f89] dark:placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Type your message here..." rows="2"></textarea>
</div>
<button id="send-btn" class="flex items-center justify-center w-12 h-12 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
<span class="material-symbols-outlined">send</span>
</button>
</div>
<div class="flex items-center justify-between mt-2">
<div class="flex items-center gap-4">
<button class="flex items-center gap-1 text-xs text-[#616f89] dark:text-gray-400 hover:text-primary transition-colors">
<span class="material-symbols-outlined text-sm">mood</span>
Suggestions
</button>
<button class="flex items-center gap-1 text-xs text-[#616f89] dark:text-gray-400 hover:text-primary transition-colors">
<span class="material-symbols-outlined text-sm">help</span>
Help
</button>
</div>
<p class="text-xs text-[#616f89] dark:text-gray-400">Remember: I'm an AI assistant, not a replacement for professional therapy</p>
</div>
</div>
</main>
</div>

<!-- Quick Suggestions Modal -->
<div id="suggestions-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
<div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full">
<h3 class="text-lg font-bold text-[#111318] dark:text-white mb-4">Quick Suggestions</h3>
<div class="space-y-2">
<button class="suggestion-btn w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" data-suggestion="I'm feeling anxious today">
<span class="text-sm text-[#111318] dark:text-white">I'm feeling anxious today</span>
</button>
<button class="suggestion-btn w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" data-suggestion="I need help with stress management">
<span class="text-sm text-[#111318] dark:text-white">I need help with stress management</span>
</button>
<button class="suggestion-btn w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" data-suggestion="I want to improve my mood">
<span class="text-sm text-[#111318] dark:text-white">I want to improve my mood</span>
</button>
<button class="suggestion-btn w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" data-suggestion="I'm having trouble sleeping">
<span class="text-sm text-[#111318] dark:text-white">I'm having trouble sleeping</span>
</button>
</div>
<div class="flex justify-end gap-2 mt-4">
<button id="close-suggestions" class="px-4 py-2 text-sm text-[#616f89] dark:text-gray-400 hover:text-[#111318] dark:hover:text-white transition-colors">Cancel</button>
</div>
</div>
</div>

<script src="js/api.js"></script>
<script>
class Chatbot {
  constructor() {
    this.messageInput = document.getElementById('message-input');
    this.sendBtn = document.getElementById('send-btn');
    this.chatMessages = document.getElementById('chat-messages');
    this.suggestionsModal = document.getElementById('suggestions-modal');
    this.clearChatBtn = document.getElementById('clear-chat-btn');
    this.connectionStatus = document.getElementById('connection-status');
    
    this.isTyping = false;
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.loadChatHistory();
  }

  setupEventListeners() {
    // Send message
    this.sendBtn.addEventListener('click', () => this.sendMessage());
    this.messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.sendMessage();
      }
    });

    // Suggestions
    document.querySelector('[data-suggestion]')?.parentElement.addEventListener('click', () => {
      this.suggestionsModal.classList.remove('hidden');
    });

    document.querySelectorAll('.suggestion-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const suggestion = e.currentTarget.getAttribute('data-suggestion');
        this.messageInput.value = suggestion;
        this.suggestionsModal.classList.add('hidden');
        this.messageInput.focus();
      });
    });

    document.getElementById('close-suggestions')?.addEventListener('click', () => {
      this.suggestionsModal.classList.add('hidden');
    });

    // Clear chat
    this.clearChatBtn.addEventListener('click', () => this.clearChat());

    // Auto-resize textarea
    this.messageInput.addEventListener('input', () => {
      this.messageInput.style.height = 'auto';
      this.messageInput.style.height = this.messageInput.scrollHeight + 'px';
    });
  }

  async sendMessage() {
    const message = this.messageInput.value.trim();
    if (!message || this.isTyping) return;

    // Add user message to chat
    this.addMessage(message, 'user');
    this.messageInput.value = '';
    this.messageInput.style.height = 'auto';

    // Show typing indicator
    this.showTypingIndicator();

    try {
      // Send to AI
      const response = await api.sendChatMessage(message);
      
      // Remove typing indicator
      this.hideTypingIndicator();
      
      // Add AI response
      this.addMessage(response.message, 'assistant');
      
    } catch (error) {
      this.hideTypingIndicator();
      this.addMessage("I'm sorry, I'm having trouble processing your request right now. Please try again later.", 'assistant');
      console.error('Chat error:', error);
    }
  }

  addMessage(content, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message flex items-start gap-3';
    
    if (sender === 'user') {
      messageDiv.innerHTML = `
        <div class="flex-1"></div>
        <div class="bg-primary text-white rounded-lg p-3 max-w-md">
          <p class="text-sm">${this.escapeHtml(content)}</p>
          <p class="text-xs opacity-70 mt-1">${this.getCurrentTime()}</p>
        </div>
        <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
          <span class="material-symbols-outlined text-primary text-sm">person</span>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
          <span class="material-symbols-outlined text-primary text-sm">psychology</span>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg p-3 max-w-md">
          <p class="text-sm text-[#111318] dark:text-white">${this.formatAIResponse(content)}</p>
          <p class="text-xs text-[#616f89] dark:text-gray-400 mt-1">${this.getCurrentTime()}</p>
        </div>
      `;
    }
    
    this.chatMessages.appendChild(messageDiv);
    this.scrollToBottom();
  }

  showTypingIndicator() {
    this.isTyping = true;
    this.sendBtn.disabled = true;
    
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'chat-message flex items-start gap-3';
    typingDiv.innerHTML = `
      <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center flex-shrink-0">
        <span class="material-symbols-outlined text-primary text-sm">psychology</span>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg p-3">
        <div class="flex items-center gap-1">
          <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s;"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s;"></div>
        </div>
      </div>
    `;
    
    this.chatMessages.appendChild(typingDiv);
    this.scrollToBottom();
  }

  hideTypingIndicator() {
    this.isTyping = false;
    this.sendBtn.disabled = false;
    
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
      typingIndicator.remove();
    }
  }

  async loadChatHistory() {
    try {
      const messages = await api.getChatHistory();
      
      // Clear existing messages except welcome message
      const welcomeMessage = this.chatMessages.querySelector('.chat-message');
      this.chatMessages.innerHTML = '';
      this.chatMessages.appendChild(welcomeMessage);
      
      // Add chat history
      messages.forEach(msg => {
        if (msg.role !== 'system') {
          this.addMessage(msg.content, msg.role);
        }
      });
      
    } catch (error) {
      console.error('Error loading chat history:', error);
    }
  }

  async clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
      try {
        // Clear local chat display
        const welcomeMessage = this.chatMessages.querySelector('.chat-message');
        this.chatMessages.innerHTML = '';
        this.chatMessages.appendChild(welcomeMessage);
        
        // Note: In a real implementation, you'd also clear the server-side chat history
        utils.showNotification('Chat cleared successfully', 'success');
        
      } catch (error) {
        console.error('Error clearing chat:', error);
        utils.showNotification('Error clearing chat', 'error');
      }
    }
  }

  scrollToBottom() {
    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
  }

  getCurrentTime() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  formatAIResponse(text) {
    // Format AI response with better line breaks and emphasis
    return text
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/\n/g, '<br>');
  }
}

// Initialize chatbot when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check authentication
  if (!auth.isAuthenticated()) {
    window.location.href = 'index.html';
    return;
  }

  // Initialize chatbot
  new Chatbot();
  
  // Dark mode functionality
  if (localStorage.getItem('darkMode') === 'true') {
    document.documentElement.classList.add('dark');
  }
});
</script>
</body>
</html>
